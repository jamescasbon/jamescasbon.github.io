<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title>casbon.me &middot; articles tagged "python"</title>
        <link rel="shortcut icon" href="http://casbon.me/favicon.ico" />
        <link href="http://casbon.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="casbon.me Atom Feed" />
                
        <link rel="stylesheet" href="http://casbon.me/theme/css/screen.css" type="text/css" />
        <link rel="stylesheet" href="http://casbon.me/theme/css/pygments.css" type="text/css" />
    </head>
    <body>
        <div id="header">
            <ul id="nav">
                <li class="ephemeral selected"><a href="http://casbon.me/tag/python.html">python</a></li>
                <li><a href="http://casbon.me">Home</a></li>
                <li><a href="http://casbon.me/archives.html">Archives</a></li>
            </ul>
            <div class="header_box">
                <h1><a href="http://casbon.me">casbon.me</a></h1>
                <h2>James Casbon's Blog</h2>
            </div>
        </div>
        <a href="https://github.com/jamescasbon">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <div id="wrapper">
            <div id="content">
                <h4 class="date">Feb 15,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/test-driven-sysadmin-with-lettuce-and-fabric" rel="bookmark" title="Permanent Link to &quot;Test Driven Sysadmin with Lettuce and Fabric&quot;">Test Driven Sysadmin with Lettuce and Fabric</a>
                    </h2>
                    
                    <p>I have been thinking about test driven sysadmin recently. We wouldn&rsquo;t want
to write code without tests, so we also shouldn&rsquo;t want to create
untestable pieces of infrastructure.</p>
<p>I think cucumber (or gherkin) could be a nice way of expressing policy:</p>
<div class="highlight"><pre><span class="n">Feature</span><span class="o">:</span> <span class="n">Mail</span>
    <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">mail</span>
<span class="err"> </span>
    <span class="n">Scenario</span><span class="o">:</span> <span class="n">Mail</span> <span class="n">relay</span>
        <span class="n">Given</span> <span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">production</span> <span class="n">server</span>
        <span class="n">And</span> <span class="n">I</span> <span class="n">am</span> <span class="n">not</span> <span class="n">a</span> <span class="n">mail</span> <span class="n">server</span> 
        <span class="n">Then</span> <span class="n">I</span> <span class="n">should</span> <span class="n">have</span> <span class="n">postfix</span> <span class="n">installed</span>
        <span class="n">And</span> <span class="n">I</span> <span class="n">should</span> <span class="n">have</span> <span class="n">a</span> <span class="n">mail</span> <span class="n">relay</span> <span class="n">to</span> <span class="n">mail</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">org</span>
<span class="err"> </span>
    <span class="n">Scenario</span><span class="o">:</span> <span class="n">Mail</span> <span class="n">server</span>
        <span class="n">Given</span> <span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">mail</span> <span class="n">server</span>
        <span class="n">Then</span> <span class="n">I</span> <span class="n">should</span> <span class="n">have</span> <span class="n">postfix</span> <span class="n">installed</span> 
        <span class="n">And</span> <span class="n">postfix</span> <span class="n">should</span> <span class="n">be</span> <span class="n">running</span> 
        <span class="n">And</span> <span class="n">I</span> <span class="n">should</span> <span class="n">be</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">25</span>
</pre></div>


<p>Now, the idea is that the scenarios are skipped when the clauses in the
&lsquo;given&rsquo; part are not met. In this case I have defined two
scenarios: a mail server and a production server to relay via a mail host. When
I run this against a host, the given clauses work out which policies to test. I
needed to teach lettuce to have skippable scenarios. You can find a rough and
ready implementation of this on <a href="https://github.com/jamescasbon/lettuce/tree/sysadmin">my branch of
lettuce</a>. Now all that is
needed is to implement the steps to check those features (which is at the
bottom of this post). </p>
<p>The nice part about this is I can write a fair amount of logic in python to
test the state of the system, but these can be calling out to fabric simple
shell calls. i.e. I don&rsquo;t need to install python onto to the system I
wish to test. Changes in policy can be tested site wide by testing a feature
against all hosts. I can also test the external view of the test machine from
my box by say, accessing a port or using an http get.</p>
<p>This is just the sketch of an idea: I need to write a command line tool to
handle the setup of of fabric hosts, and to allow multiple hosts to be tested
at once. I would also like to add a fix mode, whereby failing steps could call
out to the code that corrects a failing policy. Do you think this is a good way
to test a policy?</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">lettuce</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="err"> </span>
<span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;xxx.local&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;ip&#39;</span><span class="p">:</span> <span class="s">&#39; xxxx&#39;</span><span class="p">,</span>
            <span class="s">&#39;roles&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;production&#39;</span><span class="p">]</span>
        <span class="p">}</span>
<span class="p">}</span>
<span class="err"> </span>
<span class="c"># world is the lettuce singleton</span>
<span class="n">world</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">world</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;postfix&#39;</span><span class="p">:</span> <span class="bp">False</span> <span class="p">}</span>
<span class="err"> </span>
<span class="c"># configure fabric to point at localhost</span>
<span class="c"># and to supress output</span>
<span class="n">env</span><span class="o">.</span><span class="n">host_string</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
<span class="n">env</span><span class="o">.</span><span class="n">warn_only</span> <span class="o">=</span> <span class="bp">True</span>
<span class="kn">import</span> <span class="nn">fabric.state</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>  <span class="n">fabric</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
    <span class="n">fabric</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
<span class="err"> </span>
<span class="err"> </span>
<span class="nd">@step</span><span class="p">(</span><span class="s">&#39;I am a (\w+) server&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">has_a_role</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s">&#39;hostname&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">[</span><span class="n">hostname</span><span class="p">][</span><span class="s">&#39;roles&#39;</span><span class="p">]</span>
<span class="err"> </span>
<span class="nd">@step</span><span class="p">(</span><span class="s">&#39;I am not a (\w+) server&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">doesnt_have_a_role</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">has_a_role</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
<span class="err"> </span>
<span class="nd">@step</span><span class="p">(</span><span class="s">&#39;I should have (\w+) installed&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_installed</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
    <span class="c"># should call out to apt/rpm</span>
    <span class="k">return</span> <span class="n">world</span><span class="o">.</span><span class="n">installed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="err"> </span>
<span class="nd">@step</span><span class="p">(</span><span class="s">&#39;I should have a mail relay to (\w+)&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_mail_relay</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s">&#39;grep foo /etc/passwd&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">,</span> <span class="s">&#39;relay not set up&#39;</span>
<span class="err"> </span>
<span class="err"> </span>
<span class="nd">@step</span><span class="p">(</span><span class="s">&#39;(\w+) should be running&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_service_running</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
<span class="err"> </span>
<span class="nd">@step</span><span class="p">(</span><span class="s">&#39;I should be listening on port (\d+)&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_service_running</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/test-driven-sysadmin-with-lettuce-and-fabric">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html" class="selected">python</a>
                            <a href="http://casbon.me/tag/devops.html">devops</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>



                </div>

                <h4 class="date">Jan  9,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/html-templating-in-python-using-the-with-stat" rel="bookmark" title="Permanent Link to &quot;HTML Templating in Python using the with statement&quot;">HTML Templating in Python using the with statement</a>
                    </h2>
                    
                    <p>A few weeks back, I hacked up a simple templating language using
python's 'with' statement:</p>
<div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">Doc</span><span class="p">()</span>
<span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">:</span>

    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s">&#39;example page&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">link</span>  <span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/style.css&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">body</span> <span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="s">&#39;other stuff on another page&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/other.html&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">p</span> <span class="p">(</span><span class="s">&#39;stuff on this page&#39;</span><span class="p">)</span>
</pre></div>


<p>It was inspired by coffeekup and haml, since I find it much easier to
code html in those DSLs than with raw HTML (presumably, I need a
better editor to help match tags and indent).  HTML I write these days
tends to be as minimal as possible, and indent based languages help me
see the structure much better, which is a product of too long spent
with python.  See the gist below for the full description.</p>
<p>I posted this to <a href="https://news.ycombinator.com/item?id=3340369">Hacker
News</a> and it got into
the top ten briefly, with a few nice comments, a few why bothers and a
lot of prior art.  In particular, jperla's
<a href="http://www.jperla.com/blog/post/weby-templates-are-easier-faster-and-more-flexible">weby</a>
was very similar with a more involved syntax.  However, this getting
to the top ten shows how easy it is to have 15 seconds of fame these
days.  Next time, to number one.</p>
<p>Anyway, here is the gist:</p>
<div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A really stupid python template language inspired by coffeekup, markaby.</span>
<span class="sd">Do not use this code, it will ruin your day.  A byproduct of insomnia.</span>

<span class="sd">TL;DR</span>
<span class="sd">-----</span>

<span class="sd">This module defines a template language that allows us to do:</span>

<span class="sd">    d = Doc()</span>
<span class="sd">    with d.html:</span>

<span class="sd">        with d.head:</span>
<span class="sd">            d.title (&#39;example page&#39;)</span>
<span class="sd">            d.link  (rel=&#39;stylesheet&#39;, href=&#39;/style.css&#39;, type=&#39;text/css&#39;)</span>

<span class="sd">        with d.body (style=&#39;foo&#39;):</span>
<span class="sd">            d.a (&#39;other stuff on another page&#39;, href=&#39;/other.html&#39;)</span>
<span class="sd">            d.p (&#39;stuff on this page&#39;)</span>


<span class="sd">Motivation</span>
<span class="sd">----------</span>

<span class="sd">Python templating has always been a problem for me.  You normally have to</span>
<span class="sd">write in your target language (i.e. HTML) with some horrible syntax for</span>
<span class="sd">inlining python.  For example, this is a Cheetah [1] template:</span>

<span class="sd">    &lt;html&gt;</span>
<span class="sd">    &lt;head&gt;&lt;title&gt;$title&lt;/title&gt;&lt;/head&gt;</span>
<span class="sd">    &lt;body&gt;</span>
<span class="sd">        &lt;table&gt;</span>
<span class="sd">        #for $client in $clients</span>
<span class="sd">        &lt;tr&gt;</span>
<span class="sd">            &lt;td&gt;$client.surname, $client.firstname&lt;/td&gt;</span>
<span class="sd">            &lt;td&gt;&lt;a href=&quot;mailto:$client.email&quot;&gt;$client.email&lt;/a&gt;&lt;/td&gt;</span>
<span class="sd">        &lt;/tr&gt;</span>
<span class="sd">        #end for</span>
<span class="sd">        &lt;/table&gt;</span>
<span class="sd">    &lt;/body&gt;</span>
<span class="sd">    &lt;/html&gt;</span>

<span class="sd">We have &#39;$&#39; and &#39;#&#39; to inline python code and variables.  This to me is the</span>
<span class="sd">wrong way round.  I want to write python and not html.  I do not want to manage</span>
<span class="sd">html braces.  Tavis Rudd has pointed out that many of the arguments for</span>
<span class="sd">non python templates are unfounded [2] and I agree with him.  This has been</span>
<span class="sd">further enforced for me by using haml [3] and coffeekup [4], which leaves us in the</span>
<span class="sd">ridiculous position that the best indent based templating DSLs for html are in</span>
<span class="sd">non indent based languages (ruby, javascript).</span>

<span class="sd">This is why we can&#39;t have nice things</span>
<span class="sd">-------------------------------------</span>

<span class="sd">Coffescript and ruby have some advantage over python for a DSL including the</span>
<span class="sd">way anonymous blocks are defined and the ability to omit brackets and still get</span>
<span class="sd">function execution.  This means that the most direct python templates, such as</span>
<span class="sd">lxml builder[5] and breve [6] end up with a nested structure.  For example,</span>
<span class="sd">this is an lxml template:</span>

<span class="sd">    html = E.HTML(</span>
<span class="sd">        E.HEAD(</span>
<span class="sd">            E.LINK(rel=&quot;stylesheet&quot;, href=&quot;great.css&quot;, type=&quot;text/css&quot;),</span>
<span class="sd">            E.TITLE(&quot;Best Page Ever&quot;)</span>
<span class="sd">        ),</span>
<span class="sd">        E.BODY(</span>
<span class="sd">            E.H1(E.CLASS(&quot;heading&quot;), &quot;Top News&quot;),</span>
<span class="sd">            E.P(&quot;World News only on this page&quot;, style=&quot;font-size: 200%&quot;),</span>
<span class="sd">            &quot;Ah, and here&#39;s some more text, by the way.&quot;,</span>
<span class="sd">            lxml.html.fromstring(&quot;&lt;p&gt;    and this is a parsed fragment    &lt;/p&gt;&quot;)</span>
<span class="sd">        )</span>
<span class="sd">        )</span>

<span class="sd">Now, this code is python, but logic expressed this way still requires</span>
<span class="sd">management of parens and is not indent based - so is not really &#39;pythonic&#39;.</span>
<span class="sd">It also cannot really use conditionals and loops beyond ternarys and list comprehensions.</span>
<span class="sd">So I wondered if we could hook up a bit of magic using some other method.</span>
<span class="sd">So which way to go?  Function definitions would require too much magic, so it</span>
<span class="sd">seems that the best way is the _with_ statement.</span>

<span class="sd">The result is the style shown in the TL;DR above.  We can also</span>
<span class="sd">wrap this in a template method to use python conditional logic based</span>
<span class="sd">on supplied data:</span>

<span class="sd">    def example_template(items):</span>
<span class="sd">        d = Doc()</span>
<span class="sd">        with d.html:</span>

<span class="sd">            with d.head:</span>
<span class="sd">                d.title (&#39;other stuff on this page&#39;)</span>
<span class="sd">                d.link  (rel=&#39;stylesheet&#39;, href=&#39;/style.css&#39;, type=&#39;text/css&#39;)</span>

<span class="sd">            with d.body (style=&#39;foo&#39;):</span>
<span class="sd">                d.a (&#39;other stuff on another page&#39;, href=&#39;/other.html&#39;)</span>
<span class="sd">                d.p (&#39;stuff on this page&#39;)</span>
<span class="sd">                with d.ul:</span>
<span class="sd">                    for i in items:</span>
<span class="sd">                        with d.li:</span>
<span class="sd">                            d.a (str(i), href=str(i) + &#39;.html&#39;)</span>
<span class="sd">        return d.to_string()</span>

<span class="sd">The code below also shows template inheritance from python classes.</span>

<span class="sd">This is currently based on the lxml builder, and so it is slightly slower</span>
<span class="sd">than the elementree benchmarks [7] (which is pretty slow).  The lazy decorator</span>
<span class="sd">that allows us to miss out brackets on with statements is probably going</span>
<span class="sd">to make you cry.  Still this seems like a reasonable template language in</span>
<span class="sd">about 40 lines of code.</span>

<span class="sd">[1] http://www.cheetahtemplate.org/examples.html</span>
<span class="sd">[2] https://bitbucket.org/tavisrudd/throw-out-your-templates/src/98c5afba7f35/throw_out_your_templates.py</span>
<span class="sd">[3] http://haml-lang.com/</span>
<span class="sd">[4] http://coffeekup.org/</span>
<span class="sd">[5] http://lxml.de/dev/api/lxml.builder.ElementMaker-class.html</span>
<span class="sd">[6] http://breve.twisty-industries.com/</span>
<span class="sd">[7] http://spitfire.googlecode.com/svn/trunk/tests/perf/bigtable.py</span>

<span class="sd">Comments, abuse, etc to twitter @casualbon or casbon (at) gmail.com</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">lxml</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">lxml.html.builder</span>
<span class="kn">import</span> <span class="nn">lxml.etree</span>

<span class="k">class</span> <span class="nc">TagContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The context manager for an HTML tag &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;doc&#39;</span><span class="p">,</span> <span class="s">&#39;node&#39;</span><span class="p">,</span> <span class="s">&#39;tag&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create an html tag belonging to doc with given content and properties&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">c</span>

        <span class="n">text</span> <span class="o">+=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">builder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">())(</span><span class="o">**</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; entering the node appends it to the document stack &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; exiting the node pops it from the stack &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">each</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">():</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Lazydec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Horrible decorator to allow the with statement to omit</span>
<span class="sd">        brackets by tracking if context returned by doc has been entered</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;tagcallable&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">Doc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A document manages a stack, the head of which is the current context node &quot;&quot;&quot;</span>

    <span class="n">Context</span> <span class="o">=</span> <span class="n">TagContext</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># this node is set if text needs to be put in its tail</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Override getattr for quick tag access</span>

<span class="sd">            This means Doc.html returns a tag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; append raw text &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; append a html fragment (must be a single element) &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">fragment_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">ParserError</span><span class="p">:</span>
            <span class="n">els</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">fragments_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">els</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; convert this document to string &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pretty_print</span><span class="o">=</span><span class="n">pretty_print</span><span class="p">,</span>
                <span class="n">doctype</span><span class="o">=</span><span class="s">&#39;&lt;!DOCTYPE html&gt;&#39;</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">BootstrapContext</span><span class="p">(</span><span class="n">TagContext</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_add_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;class&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">+</span>  <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">cls</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>

        <span class="c"># support span and offset</span>
        <span class="k">for</span> <span class="n">gridcls</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;span&#39;</span><span class="p">,</span> <span class="s">&#39;offset&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">gridcls</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_class</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">gridcls</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="n">gridcls</span><span class="p">]))</span>
                <span class="n">props</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">gridcls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TagContext</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Bootstrap</span><span class="p">(</span><span class="n">Doc</span><span class="p">):</span>
    <span class="n">Context</span> <span class="o">=</span> <span class="n">BootstrapContext</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">example_template</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; template function example&quot;&quot;&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">Doc</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">p</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">():</span>
            <span class="n">d</span><span class="o">.</span><span class="n">fragment</span><span class="p">(</span><span class="s">&#39;&lt;h1&gt;no tail&lt;/h1&gt;&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s">&#39;other stuff on this page&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">link</span>  <span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/style.css&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">body</span> <span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">):</span>
                <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="s">&#39;other stuff on another page&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/other.html&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">p</span> <span class="p">(</span><span class="s">&#39;stuff on this page&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">ul</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">li</span><span class="p">():</span>

                            <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">href</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">)</span>

                <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;hi&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="s">&#39;.foo&#39;</span><span class="p">,</span> <span class="s">&#39;#bar&#39;</span><span class="p">,</span> <span class="s">&#39;inside el&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;bye&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>


    <span class="k">class</span> <span class="nc">BaseTemplate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; template inheritance example &quot;&quot;&quot;</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;base&#39;</span>

        <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">Doc</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">():</span>

                <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">():</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">link</span>  <span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/style.css&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">body</span> <span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">div</span> <span class="p">(</span><span class="s">&#39;#header&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">div</span> <span class="p">(</span><span class="s">&#39;#content&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">div</span> <span class="p">(</span><span class="s">&#39;#footer&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">footer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="s">&#39;Never read this content&#39;</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">ItemTemplate</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;item view&#39;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>

        <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s">&#39;view of </span><span class="si">%s</span><span class="s"> items&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">ul</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">li</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">li</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
                    <span class="n">li</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;the cake is a li&#39;</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">href</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bootstrap_example</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">():</span>
            <span class="n">d</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="s">&#39;#main&#39;</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">example_template</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">print</span>
    <span class="k">print</span> <span class="n">ItemTemplate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">print</span>


    <span class="k">print</span> <span class="n">bootstrap_example</span><span class="p">()</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/html-templating-in-python-using-the-with-stat">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html" class="selected">python</a>
                            <a href="http://casbon.me/tag/templates.html">templates</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>



                </div>

                <div class="clear"></div>
                <div class="pages">                
                    <a href="http://casbon.me/tag/python2.html" class="prev_page">&larr;&nbsp;Previous</a>
                    <span>Page 3 of 3</span>
                </div>

                <div class="clear"></div>
                <div id="footer">
                    <p>
                    Mockingbird theme by <a href="http://nevanscott.com/">Nevan Scott</a>
                    &middot;
                    <a class="atom" href="http://casbon.me/feeds/all.atom.xml">Feed</a>
                </div>
            </div>
            <div class="clear"></div>
        </div>
            <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-27713114-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
        <script type="text/javascript">
    var disqus_shortname = 'casbonme';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    </body>
</html>