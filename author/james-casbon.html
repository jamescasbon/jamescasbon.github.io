<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title>casbon.me &middot; Articles by James Casbon</title>
        <link rel="shortcut icon" href="http://casbon.me/favicon.ico" />
        <link href="http://casbon.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="casbon.me Atom Feed" />
                
        <link rel="stylesheet" href="http://casbon.me/theme/css/screen.css" type="text/css" />
        <link rel="stylesheet" href="http://casbon.me/theme/css/pygments.css" type="text/css" />
    </head>
    <body>
        <div id="header">
            <ul id="nav">
                <li class="ephemeral selected"><a href="http://casbon.me/author/james-casbon.html">James Casbon</a></li>
                <li><a href="http://casbon.me">Home</a></li>
                <li><a href="http://casbon.me/archives.html">Archives</a></li>
            </ul>
            <div class="header_box">
                <h1><a href="http://casbon.me">casbon.me</a></h1>
            </div>
        </div>
        <a href="https://github.com/jamescasbon">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <div id="wrapper">
            <div id="content">
                <h4 class="date">Feb 16,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/a-comparison-of-openelectv-yavdr-mythtv-and-a" rel="bookmark" title="Permanent Link to &quot;A Comparison of openelec.tv, yavdr, mythtv and a sony bravia&quot;">A Comparison of openelec.tv, yavdr, mythtv and a sony bravia</a>
                    </h2>
                    
                    <p>I recently had all my electronic goods stolen.  One of the pieces that went was
my <a href="1">MythTV</a> box, a little mini PC that recorded TV and played youtube, etc.
Fortunately, I was insured so I received a new TV and empty box.  Things have
changed a lot since I first starting using MythTV over <a href="http://www.mythtv.org/pipermail/mythtv-users/2003-November/019043.html">nine years ago</a> so 
I thought it would be a good opportunity to try out some of the other
contenders for homebrew PVRs.  In my list were: </p>
<ul>
<li><a href="2">openelec.tv</a>, an extremely minimal XBMC frontend with a TVHeadend backend</li>
<li><a href="3">yaVDR</a>: an ubuntu based VDR setup with VDR or XBMC frontends</li>
<li>Sony Bravia TV.  You could plug a HD into the replacement TV I got, it also
   supported internet video from lovefilm, etc</li>
</ul>
<p>I will first run down my experience with each...</p>
<h2>Sony Bravia TV</h2>
<p>The TV has the option to use an external HDD to record via USB.  It also
supports DLNA (more later) and has some internet TV apps (BBC iplayer,
LoveFilm).  Upon unboxing, I was surprised to receive a copy of the GPL.  It
seems some Bravias are running Linux.</p>
<p>The setup with the HDD was pure Sony crap.  The HDD needed to be initialized to work
with the TV.  This initialization was designed to make the disk unreadable
anywhere else and to ensure nothing recorded elsewhere could be played back via
USB (despite the fact it supports DLNA to access network shares).</p>
<p>Setting up a recording involved navigating to the show in the guide and hitting
record, or setting a manual timer.  There are no search options or series
records.  No management of expiry on the disk.  No watching of things being
broadcast on the same multiplex.  All in all, this resembled an 80's video
recorder for all the features it had:  basically unusable.</p>
<p>The internet videos are OK.  Iplayer and lovefilm work well, but the interfaces
are pretty slow.  There is a scroll effect in iplayer that takes ages.  But the
interesting thing, for me, is that here we have LoveFilm working on a linux box
despite the fact that it now requires Silverlight.  The only reasonable
conclusions are that Sony has a Silverlight implementation on linux or that they
have negotiated a position to allow non silverlight streaming to their device.
Vertical market/DRM integration, FTW!  </p>
<h2>openelec.tv</h2>
<p>This is a super minimal install of XBMC's pvr branch backed by TVHeadend.
Installation was easy, boots are super fast.  TVHeadend is configured via its
web interface and is easy to set up.  After install, the box sits with SAMBA and
other file sharing set up, so you can copy content straight on or off the box.</p>
<p>TVHeadend, although easy to set up, is still lacking a lot in terms of the finer
points of scheduling.  It's duplication detection just doesn't really work
expecially in terms of channels with many repeats and +1 versions.  If they fix
these, this will be a killer set up.  But as it was, I just couldn't live with
it.  It needed too much management to do a series record.</p>
<p>It also is worth noting that you cannot change anything about the openelec
install, even the ssh password.  Doing so requires that you recompile the image
which you might find a pain.  This means you can't use many things that you
would be used to on a linux install (gcc, perl, python, wget, rsync, etc).
However, that is what keeps it lightweight and robust.</p>
<h2>yaVDR</h2>
<p>yaVDR is a ubuntu setup with VDR installed.  It claims to be minimal, but
actually installs a whole bunch of crap.  VDR is the other big linux PVR project
to MythTV, but it has typically helped that you speak German if you want to read
the documentation.</p>
<p>The yaVDR install is pretty much the normal ubuntu one, and startup is similar
to a normal ubuntu box. yaVDR has a custom web front end for configuring yaVDR
and you can drop into the VDR frontend to control the PVR.  I found that the 
XBMC-pvr branch they were using was too unreliable to use and
so I was using the VDR frontend.  This was a little tricky as it is designed
around a remote (which I didn't have).</p>
<p>My experience with VDR was almost as frustrating as with TVHeadend.  You can
have automated recordings, but for channels with +1s and repeats and different
episodes it never seemed to get things correct.  VDR is based around plugins so
it may have been that I could have found something to rectify that, but I never
could get a satisfactory set up.</p>
<h2>Aside: XBMC-pvr, uPNP, DLNA</h2>
<p>While I was trying these setups, I was also testing out whether they could
stream direct to the Bravia TV which supports DLNA.  This is a subset of
uPNP with certain codecs.  TVHeadend did not support DLNA and neither did VDR.
However, there was a plugin for VDR that supports uPNP.  However, I could not
get this to work with streaming DVB broadcasts to the Sony TV.  </p>
<p>I had higher hopes for XBMC.  It has a reasonable uPNP server, but you soon find
the problems (including unsorted albums: http://forum.xbmc.org/showthread.php?t=105141) 
but more troublesome is the fact that the TV shows in XBMC are not served via
uPNP at all.  </p>
<h2>Back to Myth</h2>
<p>After all this, I installed a linux distribution and put Myth on top.  The Myth
setup was pretty painless (channel scan even worked), but partly this is because 
I know all the problems too well.</p>
<p>The worst thing about Myth is that the frontend is pretty awful.  I did try to
go the XBMC-pvr route, but the integration is very alpha quality.  However, I
was pleased to find that this didn't matter.  The uPNP server from myth is
awesome, everything is listed in various categories (date, title, etc) and
playback is fine.</p>
<p>Add in MythWeb and I think you have a perfect PVR.  Mythweb is good for
searching, scheduling and the flash based streaming is great.</p>
<h2>Conclusions</h2>
<p>So TL;DR: MythTV is awesome with a DLNA television.  Openelec.tv will be awesome
when TVHeadend's scheduling is better.</p>
<p>Also: there's nothing on TV so save your money and buy a book.</p>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/a-comparison-of-openelectv-yavdr-mythtv-and-a">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/pvr.html" rel="tag">PVR</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/mythtv.html">mythtv</a>
                            <a href="http://casbon.me/tag/pvr.html">pvr</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>
                </div>

                <h4 class="date">Dec  3,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/a-python-map-reduce-data-store" rel="bookmark" title="Permanent Link to &quot;A Python Map Reduce Data Store&quot;">A Python Map Reduce Data Store</a>
                    </h2>
                    
                    <p>I'm pleased to announce the release of a data store with python map reduce
capabilities that is also fully ACID compliant, supports SQL as a query
language, foreign keys and joins.  It is also well supported by numerous
companies and already available in many hosted environments.  Just kidding: I'm
talking, of course, about PostgreSQL. I only recently discovered the <a href="http://www.postgresql.org/docs/9.2/static/plpython.html">excellent
python support</a> in Postgres, 
which allows you to run python functions inside queries.  This allows you to
create a python map reduce system with very little effort.  Of course, the point
of map reduce is more about distributing the computation, but if you're prepared
to don some <a href="http://en.wikipedia.org/wiki/Cargo_cult">wooden headphones</a> for a 
moment...</p>
<p>First you need to install the plpython package (something like <code>postgresql-plpython-9.2</code>)
and install it in your database <code>postgres createlang plpython3u DBNAME</code>.</p>
<p>Now create our pymap function: </p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">pymap</span> <span class="p">(</span><span class="n">src</span> <span class="nb">text</span><span class="p">,</span> <span class="n">table_name</span> <span class="nb">text</span><span class="p">)</span>
   <span class="k">RETURNS</span> <span class="k">SETOF</span> <span class="nb">json</span>
<span class="k">AS</span> <span class="s">$$</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="k">exec</span> <span class="n">src</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">plpy</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT key, value FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">map_fn</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">],</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&quot;value&quot;</span><span class="p">])):</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">emission</span><span class="p">)</span>

<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span>
</pre></div>


<p>A test table, which is a key value table:</p>
<div class="highlight"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">kv</span> <span class="p">(</span><span class="k">key</span> <span class="nb">serial</span><span class="p">,</span> <span class="k">value</span> <span class="nb">json</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">kv</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;{&quot;foo&quot;: 100}&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">kv</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;{&quot;foo&quot;: 200}&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">kv</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;{&quot;bar&quot;: 300}&#39;</span><span class="p">);</span>
</pre></div>


<p>Now we can use our pymap function by passing in a table name and python source
(which defines a map_fn):</p>
<div class="highlight"><pre><span class="k">select</span> <span class="n">pymap</span><span class="p">(</span><span class="s1">&#39;kv;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span>
<span class="s1">def map_fn(k, v):</span>
<span class="s1">  if &quot;foo&quot; in v:  </span>
<span class="s1">    yield {k: v[&quot;foo&quot;]}&#39;</span>
<span class="s1">&#39;&#39;</span><span class="p">);</span>

   <span class="n">pymap</span>    
<span class="c1">------------</span>
 <span class="p">{</span><span class="s-Name">&quot;1&quot;</span><span class="p">:</span> <span class="mf">100</span><span class="p">}</span>
 <span class="p">{</span><span class="s-Name">&quot;2&quot;</span><span class="p">:</span> <span class="mf">200</span><span class="p">}</span>
<span class="p">(</span><span class="mf">2</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>


<p>But this is python, so lets do something more interesting, like use scipy to
calculate the gamma function...</p>
<div class="highlight"><pre><span class="k">select</span> <span class="n">pymap</span><span class="p">(</span><span class="s1">&#39;kv;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span>
<span class="s1">def map_fn(k, v):</span>
<span class="s1">  import scipy.special</span>
<span class="s1">  if &quot;foo&quot; in v:  </span>
<span class="s1">    yield {k: scipy.special.gamma(float(v[&quot;foo&quot;])/1000)}&#39;</span>
<span class="s1">&#39;&#39;</span><span class="p">);</span>

           <span class="n">pymap</span>           
<span class="c1">---------------------------</span>
 <span class="p">{</span><span class="s-Name">&quot;1&quot;</span><span class="p">:</span> <span class="mf">9.5135076986687324</span><span class="p">}</span>
 <span class="p">{</span><span class="s-Name">&quot;2&quot;</span><span class="p">:</span> <span class="mf">4.5908437119988026</span><span class="p">}</span>
<span class="p">(</span><span class="mf">2</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>


<p>I'll leave the implementation of reduce as an exercise to the reader.  I hope
this has shown how useful having a full python interpreter in the database can
be.  There are currently versions for both python 2 and 3, but it would be
really nice if we had a link to libpypy-c which would then give JITed functions.</p>
<p>One potential use of plpython is that you can use it to create indexes on
computed values. If you've ever worked on a system that stores serialized
objects in a database, you'll understand what I mean.  To add an index to these,
you have to alter your database <em>and</em> code to store extra the extra data and then index it.
With plpython you could generate the index in the database without altering your data storage code:</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">two_of_foo</span> <span class="p">(</span><span class="n">v</span> <span class="nb">json</span><span class="p">)</span>
  <span class="k">RETURNS</span> <span class="nb">integer</span>
<span class="k">AS</span> <span class="s">$$</span>
  <span class="kn">import</span> <span class="nn">json</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="k">if</span> <span class="s">&#39;foo&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span> 
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>
 <span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span> <span class="k">IMMUTABLE</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">i_two_of_foo</span> <span class="k">ON</span> <span class="n">kv</span> <span class="p">(</span><span class="n">two_of_foo</span><span class="p">(</span><span class="k">value</span><span class="p">));</span>
</pre></div>


<p>Update: Anja Skrba kindly translated this page into <a href="http://science.webhostinggeeks.com/skladistenje-podataka">Serbo-Croatian</a></p>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/a-python-map-reduce-data-store">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html">python</a>
                            <a href="http://casbon.me/tag/postgresql.html">postgresql</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>
                </div>

                <h4 class="date">Apr 18,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/backbonejs-handlers-for-tornado-and-mongodb" rel="bookmark" title="Permanent Link to &quot;Backbone.js handlers for Tornado and MongoDB&quot;">Backbone.js handlers for Tornado and MongoDB</a>
                    </h2>
                    
                    <div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Backbone.js handler and mongodb based handler for Tornado.</span>

<span class="sd">`BackboneHandler` handles the sync protocol for Backbone.js.  Inherit</span>
<span class="sd">from the class and implement the model methods:</span>
<span class="sd">    * create_model</span>
<span class="sd">    * update_model</span>
<span class="sd">    * get_model</span>
<span class="sd">    * delete_model</span>
<span class="sd">    * get_collection</span>
<span class="sd">Optionally implement is_get_collection for complex url routing schemes.</span>

<span class="sd">`MongoBackboneHandler` implements these methods using a mongodb database.</span>
<span class="sd">Inherit and implement the:</span>
<span class="sd">    * model_query</span>
<span class="sd">    * collection_query</span>
<span class="sd">    * is_get_collection</span>
<span class="sd">methods to map url arguments into database queries.  Also optionally implement:</span>
<span class="sd">    * before_create</span>
<span class="sd">    * before_update</span>
<span class="sd">    * validate</span>
<span class="sd">To validate and insert data into a document before a create/update</span>

<span class="sd">TODO: async version</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.httpserver</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">pymongo.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>


<span class="k">class</span> <span class="nc">BackboneHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; authenticate user if required &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c"># HTTP Verbs / Backbone.js API</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the collection or a model  &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_get_collection</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create a model &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; update a model &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; delete a model &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


    <span class="c"># Extension points</span>

    <span class="k">def</span> <span class="nf">is_get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return true if this get is for a collection &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create model and return a dictionary of updated attributes &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the collection &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return a model, return None to indicate not found &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; update a model &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; delete a model &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">MongoBackboneHandler</span><span class="p">(</span><span class="n">BackboneHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="n">BackboneHandler</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

    <span class="c"># BackboneHandler extension</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">Cursor</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;_id&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c"># we have a cursor</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;_id&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;_id&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_create</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="n">updates</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="k">def</span> <span class="nf">get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_query</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_query</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_update</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_query</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="k">def</span> <span class="nf">delete_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_query</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

    <span class="c"># Extension points</span>

    <span class="k">def</span> <span class="nf">collection_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the query to find a collection from a list of url args &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">model_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the query to find a model &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])}</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return False to to disallow this model &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">before_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return any extra attributes you want to add to the model &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">before_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;backbone&#39;</span><span class="p">:</span>


        <span class="k">class</span> <span class="nc">TestHandler</span><span class="p">(</span><span class="n">BackboneHandler</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot; we want to check auth/noauth &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="s">&#39;test&#39;</span>

            <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="s">&#39;X&#39;</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

            <span class="k">def</span> <span class="nf">_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cid</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ms</span> <span class="k">else</span> <span class="bp">None</span>

            <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
                <span class="n">model</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="n">model</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>

            <span class="k">def</span> <span class="nf">get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span>

            <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;updating&#39;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">cid</span><span class="p">))]</span> <span class="o">=</span> <span class="n">model</span>

            <span class="k">def</span> <span class="nf">delete_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;deleting&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">cid</span><span class="p">))</span>



        <span class="n">application</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
                <span class="p">(</span><span class="s">r&quot;/api&quot;</span><span class="p">,</span> <span class="n">TestHandler</span><span class="p">),</span>
                <span class="p">(</span><span class="s">r&quot;/api/(.+)&quot;</span><span class="p">,</span> <span class="n">TestHandler</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">static_path</span><span class="o">=</span><span class="s">&#39;static&#39;</span><span class="p">,</span>
        <span class="p">)</span>


        <span class="n">application</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tornado.testing</span>
        <span class="kn">import</span> <span class="nn">unittest</span>
        <span class="kn">import</span> <span class="nn">urllib</span>

        <span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">MongoBackboneHandler</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">before_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">created</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>




        <span class="k">class</span> <span class="nc">TestMongo</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">AsyncHTTPTestCase</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s">&#39;bh_test&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;bh_test&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">AsyncHTTPTestCase</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">AsyncHTTPTestCase</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="s">&#39;bh_test&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">get_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
                        <span class="p">(</span><span class="s">r&quot;/api/&quot;</span><span class="p">,</span> <span class="n">Handler</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coll</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">False</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s">r&quot;/api/(.+)&quot;</span><span class="p">,</span> <span class="n">Handler</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coll</span><span class="p">,</span>
                            <span class="n">auth</span><span class="o">=</span><span class="bp">False</span><span class="p">)),</span>
                    <span class="p">],</span>
                    <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">static_path</span><span class="o">=</span><span class="s">&#39;static&#39;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">],</span>  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;/api/&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
                <span class="n">models</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;a&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">post_args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;bro@bro.com&#39;</span><span class="p">}</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;/api/&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_args</span><span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;_id&#39;</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="n">model</span><span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1234&#39;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;PUT&#39;</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">],</span> <span class="s">&#39;1234&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_delete_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;DELETE&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


        <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/backbonejs-handlers-for-tornado-and-mongodb">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html">python</a>
                            <a href="http://casbon.me/tag/tornado.html">tornado</a>
                            <a href="http://casbon.me/tag/mongodb.html">mongodb</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="clear"></div>
                <div class="pages">
                    <a href="http://casbon.me/author/james-casbon2.html" class="next_page">Next&nbsp;&rarr;</a>
                    <span>Page 1 of 3</span>
                </div>

                <div class="clear"></div>
                <div id="footer">
                    <p>
                    Mockingbird theme by <a href="http://nevanscott.com/">Nevan Scott</a>
                    &middot;
                    <a class="atom" href="http://casbon.me/feeds/all.atom.xml">Feed</a>
                </div>
            </div>
            <div class="clear"></div>
        </div>
            <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-27713114-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
        
    </body>
</html>