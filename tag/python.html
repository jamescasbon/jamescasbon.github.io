<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title>casbon.me &middot; articles tagged "python"</title>
        <link rel="shortcut icon" href="/favicon.ico" />
                
        <link rel="stylesheet" href="/theme/css/screen.css" type="text/css" />
        <link rel="stylesheet" href="/theme/css/pygments.css" type="text/css" />
    </head>
    <body>
        <div id="header">
            <ul id="nav">
                <li class="ephemeral selected"><a href="/tag/python.html">python</a></li>
                <li><a href="">Home</a></li>
                <li><a href="/archives.html">Archives</a></li>
            </ul>
            <div class="header_box">
                <h1><a href="">casbon.me</a></h1>
            </div>
        </div>
        <div id="wrapper">
            <div id="content">
                <h4 class="date">Dec  3,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="/a-python-map-reduce-data-store.html" rel="bookmark" title="Permanent Link to &quot;A Python Map Reduce Data Store&quot;">A Python Map Reduce Data Store</a>
                    </h2>
                    
                    <p>I'm pleased to announce the release of a data store with python map reduce
capabilities that is also fully ACID compliant, supports SQL as a query
language, foreign keys and joins.  It is also well supported by numerous
companies and already available in many hosted environments.  Just kidding: I'm
talking, of course, about PostgreSQL. I only recently discovered the <a href="http://www.postgresql.org/docs/9.2/static/plpython.html">excellent
python support</a> in Postgres, 
which allows you to run python functions inside queries.  This allows you to
create a python map reduce system with very little effort.  Of course, the point
of map reduce is more about distributing the computation, but if you're prepared
to don some <a href="http://en.wikipedia.org/wiki/Cargo_cult">wooden headphones</a> for a 
moment...</p>
<p>First you need to install the plpython package (something like <code>postgresql-plpython-9.2</code>)
and install it in your database <code>postgres createlang plpython3u DBNAME</code>.</p>
<p>Now create our pymap function: </p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">pymap</span> <span class="p">(</span><span class="n">src</span> <span class="nb">text</span><span class="p">,</span> <span class="n">table_name</span> <span class="nb">text</span><span class="p">)</span>
   <span class="k">RETURNS</span> <span class="k">SETOF</span> <span class="nb">json</span>
<span class="k">AS</span> <span class="s">$$</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="k">exec</span> <span class="n">src</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">plpy</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT key, value FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">map_fn</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">],</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&quot;value&quot;</span><span class="p">])):</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">emission</span><span class="p">)</span>

<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span>
</pre></div>


<p>A test table, which is a key value table:</p>
<div class="highlight"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">kv</span> <span class="p">(</span><span class="k">key</span> <span class="nb">serial</span><span class="p">,</span> <span class="k">value</span> <span class="nb">json</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">kv</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;{&quot;foo&quot;: 100}&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">kv</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;{&quot;foo&quot;: 200}&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">kv</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;{&quot;bar&quot;: 300}&#39;</span><span class="p">);</span>
</pre></div>


<p>Now we can use our pymap function by passing in a table name and python source
(which defines a map_fn):</p>
<div class="highlight"><pre><span class="k">select</span> <span class="n">pymap</span><span class="p">(</span><span class="s1">&#39;kv;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span>
<span class="s1">def map_fn(k, v):</span>
<span class="s1">  if &quot;foo&quot; in v:  </span>
<span class="s1">    yield {k: v[&quot;foo&quot;]}&#39;</span>
<span class="s1">&#39;&#39;</span><span class="p">);</span>

   <span class="n">pymap</span>    
<span class="c1">------------</span>
 <span class="p">{</span><span class="s-Name">&quot;1&quot;</span><span class="p">:</span> <span class="mf">100</span><span class="p">}</span>
 <span class="p">{</span><span class="s-Name">&quot;2&quot;</span><span class="p">:</span> <span class="mf">200</span><span class="p">}</span>
<span class="p">(</span><span class="mf">2</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>


<p>But this is python, so lets do something more interesting, like use scipy to
calculate the gamma function...</p>
<div class="highlight"><pre><span class="k">select</span> <span class="n">pymap</span><span class="p">(</span><span class="s1">&#39;kv;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span>
<span class="s1">def map_fn(k, v):</span>
<span class="s1">  import scipy.special</span>
<span class="s1">  if &quot;foo&quot; in v:  </span>
<span class="s1">    yield {k: scipy.special.gamma(float(v[&quot;foo&quot;])/1000)}&#39;</span>
<span class="s1">&#39;&#39;</span><span class="p">);</span>

           <span class="n">pymap</span>           
<span class="c1">---------------------------</span>
 <span class="p">{</span><span class="s-Name">&quot;1&quot;</span><span class="p">:</span> <span class="mf">9.5135076986687324</span><span class="p">}</span>
 <span class="p">{</span><span class="s-Name">&quot;2&quot;</span><span class="p">:</span> <span class="mf">4.5908437119988026</span><span class="p">}</span>
<span class="p">(</span><span class="mf">2</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>


<p>I'll leave the implementation of reduce as an exercise to the reader.  I hope
this has shown how useful having a full python interpreter in the database can
be.  There are currently versions for both python 2 and 3, but it would be
really nice if we had a link to libpypy-c which would then give JITed functions.</p>
<p>One potential use of plpython is that you can use it to create indexes on
computed values. If you've ever worked on a system that stores serialized
objects in a database, you'll understand what I mean.  To add an index to these,
you have to alter your database <em>and</em> code to store extra the extra data and then index it.
With plpython you could generate the index in the database without altering your data storage code:</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">two_of_foo</span> <span class="p">(</span><span class="n">v</span> <span class="nb">json</span><span class="p">)</span>
  <span class="k">RETURNS</span> <span class="nb">integer</span>
<span class="k">AS</span> <span class="s">$$</span>
  <span class="kn">import</span> <span class="nn">json</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="k">if</span> <span class="s">&#39;foo&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span> 
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>
 <span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span> <span class="k">IMMUTABLE</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">i_two_of_foo</span> <span class="k">ON</span> <span class="n">kv</span> <span class="p">(</span><span class="n">two_of_foo</span><span class="p">(</span><span class="k">value</span><span class="p">));</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="/a-python-map-reduce-data-store.html">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="/tag/python.html" class="selected">python</a>
                            <a href="/tag/postgresql.html">postgresql</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>
                </div>

                <h4 class="date">Jun  3,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="/connecting-to-githubs-oauth2-api-with-tornado.html" rel="bookmark" title="Permanent Link to &quot;Connecting to Github's OAuth2 API with Tornado&quot;">Connecting to Github's OAuth2 API with Tornado</a>
                    </h2>
                    
                    <p>Github has a nice OAuth2 API that we can use to manipulate git repos, gists,
etc.  I went through the process of implementing a Tornado based client for the
API.  This could allow a github backed application.  Note here, we are still
performing server side operations, so the client is relatively simple.  An
alternative approach is to do the github interaction in the browser.  If you are
interested in that, check this library.</p>
<p>Tornado takes a callback based approach, and we need to code the entire OAuth2
dance in this way.  There is an base class, tornado.auth.OAuth2Mixin, which can
perform a very small subset of the protocol.  The steps we need to log in a
user:</p>
<ol>
<li>
<p>Get an authorization code using authorize_redirect method from the base class.
This presents the user with a 'do you want to authorize this app dialog in
github'.  Github then posts back to our app with the code</p>
</li>
<li>
<p>Get a user access token by exchanging the code for an access token.  This is
done via a simple GET.  This means the user is now logged in.</p>
</li>
<li>
<p>Get the user details by asking the API for the user information</p>
</li>
<li>
<p>Parse the user information and store the relevant details in a session/whatever</p>
</li>
</ol>
<p>Here is a base class that takes care of many of these details.
get_authenticated_user needs an authorization code, which it uses to get an
access token.  If it succeeds, it calls _on_access_code, which makes an API
request to /user.  This is then returned to the callback set by the original
caller of get_authenticated_user.  It also provides github_request, which makes
an API call and hands the data to _parse_response which in turn hands it to the
callback specified by the caller.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.auth</span>
<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.httputil</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="k">class</span> <span class="nc">GithubMixin</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">OAuth2Mixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Github OAuth Mixin, based on FacebookGraphMixin</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_OAUTH_AUTHORIZE_URL</span> <span class="o">=</span> <span class="s">&#39;https://github.com/login/oauth/authorize&#39;</span>
    <span class="n">_OAUTH_ACCESS_TOKEN_URL</span> <span class="o">=</span> <span class="s">&#39;https://github.com/login/oauth/access_token&#39;</span>
    <span class="n">_API_URL</span> <span class="o">=</span> <span class="s">&#39;https://api.github.com&#39;</span>

    <span class="k">def</span> <span class="nf">get_authenticated_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span>
                            <span class="n">code</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">extra_fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handles the login for Github, queries /user and returns a user object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;gau &#39;</span> <span class="o">+</span> <span class="n">redirect_uri</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
        <span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="s">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">client_secret</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_token_url</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_access_token</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span>
                                <span class="n">client_secret</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">fields</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span>
                        <span class="n">callback</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; callback for authentication url, if successful get the user details &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Github auth error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">parse_qs_bytes</span><span class="p">(</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;oauth error &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">github_request</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s">&quot;/user&quot;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_get_user_info</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">session</span><span class="p">),</span>
            <span class="n">access_token</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_get_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; callback for github request /user to create a user &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;user data from github &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">callback</span><span class="p">({</span>
            <span class="s">&quot;login&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;login&quot;</span><span class="p">],</span>
            <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">],</span>
            <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">],</span>
            <span class="s">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">],</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">github_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Makes a github API request, hands callback the parsed data &quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httputil</span><span class="o">.</span><span class="n">url_concat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_API_URL</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;request to &#39;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;body is&#39;</span> <span class="o">+</span>  <span class="n">body</span><span class="p">)</span>
        <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">,</span> <span class="n">callback</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse the JSON from the API &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;HTTP error from Github: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Invalid JSON from Github: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;error_code&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Facebook error: </span><span class="si">%d</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="p">[</span><span class="s">&quot;error_code&quot;</span><span class="p">],</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;error_msg&quot;</span><span class="p">))</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
</pre></div>


<p>We can use this, as below, to create handlers to login a user - and in this case
store the credentials in a secure cookie - or to make an API call for a logged
in user:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.options</span>
<span class="kn">import</span> <span class="nn">tornado.httputil</span>
<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">import</span> <span class="nn">pyjade.compiler</span>
<span class="kn">import</span> <span class="nn">coffeescript</span>
<span class="kn">import</span> <span class="nn">markdown</span>

<span class="kn">import</span> <span class="nn">github</span>


<span class="k">class</span> <span class="nc">GithubLoginHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="n">github</span><span class="o">.</span><span class="n">GithubMixin</span><span class="p">):</span>

    <span class="n">_OAUTH_REDIRECT_URL</span> <span class="o">=</span> <span class="s">&#39;http://localhost:8888/auth/github&#39;</span>

    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># we can append next to the redirect uri, so the user gets the</span>
        <span class="c"># correct URL on login</span>
        <span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httputil</span><span class="o">.</span><span class="n">url_concat</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_REDIRECT_URL</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;next&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;next&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)})</span>

        <span class="c"># if we have a code, we have been authorized so we can log in</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticated_user</span><span class="p">(</span>
                <span class="n">redirect_uri</span><span class="o">=</span><span class="n">redirect_uri</span><span class="p">,</span>
                <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;github_client_id&quot;</span><span class="p">],</span>
                <span class="n">client_secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;github_secret&quot;</span><span class="p">],</span>
                <span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">),</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_login</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># otherwise we need to request an authorization code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorize_redirect</span><span class="p">(</span>
                <span class="n">redirect_uri</span><span class="o">=</span><span class="n">redirect_uri</span><span class="p">,</span>
                <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;github_client_id&quot;</span><span class="p">],</span>
                <span class="n">extra_params</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;scope&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;github_scope&#39;</span><span class="p">],</span> <span class="s">&quot;foo&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_on_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This handles the user object from the login request &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;logged in user from github: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_secure_cookie</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">GistLister</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">,</span> <span class="n">github</span><span class="o">.</span><span class="n">GithubMixin</span><span class="p">):</span>

    <span class="nd">@tornado.web.authenticated</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">github_request</span><span class="p">(</span>
                <span class="s">&#39;/gists&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_get_gists</span><span class="p">,</span>
                <span class="n">access_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&#39;access_token&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_on_get_gists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gists</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;gists.jade&#39;</span><span class="p">,</span> <span class="n">gists</span><span class="o">=</span><span class="n">gists</span><span class="p">)</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="/connecting-to-githubs-oauth2-api-with-tornado.html">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="/tag/python.html" class="selected">python</a>
                            <a href="/tag/tornado.html">tornado</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>
                </div>

                <h4 class="date">Feb 21,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="/what-will-pypy-do-for-your-website-benchmarki.html" rel="bookmark" title="Permanent Link to &quot;What will pypy do for your website?&quot;">What will pypy do for your website?</a>
                    </h2>
                    
                    <p>There are currently quite a few different ways of developing a web application in python.&nbsp; When you add in how you deploy the application as well, there are even more choices.&nbsp; In terms of application frameworks, you have at least:</p>

<ul>
<li>Django</li>
<li>twisted.web</li>
<li>flask</li>
<li>bottle</li>
<li>cyclone</li>
<li>tornado</li>
<li>pyramid</li>
</ul>

<p>Then these can be run using many different servers, including:</p>

<ul>
<li>tornado</li>
<li>twisted</li>
<li>cyclone</li>
<li>wsgiref</li>
<li>rocket</li>
<li>cherrypy</li>
<li>gunicorn</li>
<li>fapws</li>
<li>google app engine</li>
<li>gevent</li>
</ul>

<p>And many more.&nbsp; Typically, these take one of several approaches.&nbsp; Asynchronous either explicit (cyclone, tornado) or via monkey patch and event loop (gevent); threaded such as rocket, or written in C to use an event loop.&nbsp; In addition to this, you now have several different pythons for deployment:</p>

<ul>
<li>cpython </li>
<li>jython</li>
<li>pypy</li>
</ul>

<p>At some point, these servers are generally dealing with asynchronous event loops or using threading.&nbsp; The two approaches to handling this are either to program in a normal style (gevent) or to explicitly use event based programming (eg cyclone).&nbsp; The rise of javascript and node.js has seen event based programming becoming more mainstream.&nbsp; I wanted to find out which of these many combinations would perform best, and in particular what effect using pypy as the interpreter would have on the performance.</p>

<p><strong>The benchmark</strong></p>

<p>I created a fairly simple benchmark and implemented it across the different application styles.&nbsp; The benchmark creates one route which renders 'Hello world', a click counter stored by redis that we increase, and finally a static 2,000 character string that we retrieve from redis.&nbsp; I then run ab against the application for 10,000 requests for three replicates at different levels of concurrency (4, 16, 64, 256 connections).&nbsp; We take the stats for the requests per second and also the total request time averages, range and standard deviation.</p>

<p>These were run on a linux box with the kernel 'Linux 2.6.41.4-1.fc15.x86_64 #1 SMP Tue Nov 29 11:53:48 UTC 2011 x86_64 x86_64 x86_64 GNU/Linux' and 24 core 'Intel(R) Xeon(R) CPU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; X5675&nbsp; @ 3.07GH' (although only one core will be used for python) and 48Gb ram.&nbsp; The pythons used were 'Python 2.7.1' and 'Python 2.7.2, [PyPy 1.8.0 with GCC 4.4.6]'.</p>

<p>You can run the benchmark by checking out <a href="https://github.com/jamescasbon/pypy-web-benchmarks">the repository</a> on github.&nbsp; If you know anything about the application styles, I would encourage you to take a look at the implementations in the servers directory.</p>

<p>The versions used are:</p>

<ul>
<li>Flask==0.8</li>
<li>Paste==1.7.5.1</li>
<li>Rocket==1.2.4</li>
<li>Twisted==12.0.0</li>
<li>WebOb==1.2b3</li>
<li>Werkzeug==0.8.3</li>
<li>bottle==0.10.9</li>
<li>bottle-redis==0.1</li>
<li>cyclone==1.0-rc3</li>
<li>distribute==0.6.24</li>
<li>pyramid==1.3a8</li>
<li>redis==2.4.11</li>
<li>repoze.lru==0.4</li>
<li>tornado==2.2</li>
<li>gevent==1.0dev</li>
<li>greenlet==0.3.4</li>
<li>eventlet==0.9.16</li>
<li>CherryPy==3.2.2</li>
</ul>

<p>I patched bottle-redis to use a connection queue and bottle to silence the logging when using gevent.&nbsp; Twisted needs C extensions disabled to install on pypy.</p>

<p><strong>Results</strong></p>

<p><em>JIT effect</em></p>

<p>The first thing to notice is that pypy takes a little time to optmize the code.&nbsp; This plot shows the requests per second for each test in iterations 1, 2 and 3.&nbsp; Pypy is on the left (True) and cpython on the right (False).&nbsp; The vertical facet is by the concurrency.<img class="posterous_plugin_object posterous_plugin_object_image" src="http://getfile7.posterous.com/getfile/files.posterous.com/temp-2012-02-23/bmGaFmoDEaBqAGjrHIwctEpfeabsnHEaeutztuqpdHjdJxxiDwDDJnHzcEcz/jit-effect.png.thumb100.png?content_part=aaCDhogwbAdzqCsGmFbq" alt="" width="100" height="100" /></p>

<p>You can clearly see the effect of the JIT. Cpython, on the right, has stable performance across all iterations.&nbsp; Pypy shows a marked improvement from the second iteration.</p>

<p><em>Requests per second</em></p>

<p>We now look at requests per second against concurrency across all combinations of application and server.&nbsp; Each box contains pypy and cpython lines, where available.&nbsp; These are from the third iteration, when the JIT compiler has done its work</p>

<p><img class="posterous_plugin_object posterous_plugin_object_image" src="http://getfile3.posterous.com/getfile/files.posterous.com/temp-2012-02-23/oyJiczHyxdCdJwbgpffzzgbjoGoBizIBtauIJnotAorbFkJqDmDmhCtphBxo/rqs.png.thumb100.png?content_part=xDzhccdximrxsAdxugtb" alt="" width="100" height="100" /></p>

<p>Looking at this, you can see a few things.&nbsp; <span style="text-decoration: line-through;">Twisted and</span> Cherrypy and paste are not really stable under increasing concurrency shown by the lines sloping to the right or incomplete lines (server failed).&nbsp; Gevent, tornado and cyclone are stable under loads and show fairly equivalent performance under cpython.&nbsp; Pypy introduces a 1.5-2x performance increase for almost all servers.</p>

<p>Comparing the microframeworks, flask and bottle, bottle is always faster and really flies under tornado and gevent.&nbsp; Pyramid does the best and serves over 5,000 requests per second with tornado and pypy.&nbsp; Cyclone comes second under pypy with over 3,500 requests per second.&nbsp; However, I found the lack of performance increase over tornado and bottle slightly dissapointing, since cyclone is using an async redis connection.</p>

<p><em>Response time</em></p>

<p>Here we look at the average response time, its standard deviation, and the maximum response time.&nbsp; A very similar picture for all technologies: under increasing concurrency the response times degrade.</p>

<p><img class="posterous_plugin_object posterous_plugin_object_image" src="http://getfile2.posterous.com/getfile/files.posterous.com/temp-2012-02-23/FwsagyymsgqhcnnygqsviuvDnudBClIjHJwdhFyGpczbDADlCBlrblklzllq/time.png.thumb100.png?content_part=hBDrHrchezHukbcegIfg" alt="" width="100" height="100" /></p>

<p>No clear winner between pypy and cpython.</p>

<p><strong>Conclusions</strong></p>

<ul>
<li>Gevent and tornado have excellent WSGI servers that can serve 1,000s of requests per second. </li>
<li>Pypy can provide 1.5-2x performance, and this is available with tornado and cyclone but not gevent</li>
<li>Explicit async code in cyclone did not provide a noticeable increase in performance over tornado, pyramid and bottle</li>
<li>bottle outperforms flask and really flies with gevent and tornado</li>
<li>pyramid is really fast with gevent and tornado</li>
<li>threading approaches don't seem to match the other approaches here </li>
<li>cherrypy seems to have problems with higher concurrencies</li>
</ul>

<p>Overall, I think this shows if you are really interested in performance you should take a good look at pypy.&nbsp; I have a lot of respect for the tornado code now, and would seriously consider it for future projects.&nbsp; Bottle is a very good microframework that outperforms flask.</p>

<p><strong>Changes</strong></p>

<p>23/2/12 Add cherrypy, eventlet, created common wsgi server code<strong>.&nbsp; </strong>Couldn't get eventlet to run stable under pypy (socket and RPy errors).<strong><br /></strong></p>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="/what-will-pypy-do-for-your-website-benchmarki.html">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="/tag/python.html" class="selected">python</a>
                            <a href="/tag/postgresql.html">postgresql</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="clear"></div>
                <div class="pages">
                    <a href="/tag/python2.html" class="next_page">Next&nbsp;&rarr;</a>
                    <span>Page 1 of 2</span>
                </div>

                <div class="clear"></div>
                <div id="footer">
                    <p>
                    Mockingbird theme by <a href="http://nevanscott.com/">Nevan Scott</a>
                    &middot;
                    <a class="atom" href="/None">Feed</a>
                </div>
            </div>
            <div class="clear"></div>
        </div>
    </body>
</html>