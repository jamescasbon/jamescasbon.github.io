<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title>casbon.me &middot; Articles by James Casbon</title>
        <link rel="shortcut icon" href="http://casbon.me/favicon.ico" />
        <link href="http://casbon.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="casbon.me Atom Feed" />
                
        <link rel="stylesheet" href="http://casbon.me/theme/css/screen.css" type="text/css" />
        <link rel="stylesheet" href="http://casbon.me/theme/css/pygments.css" type="text/css" />
    </head>
    <body>
        <div id="header">
            <ul id="nav">
                <li class="ephemeral selected"><a href="http://casbon.me/author/james-casbon.html">James Casbon</a></li>
                <li><a href="http://casbon.me">Home</a></li>
                <li><a href="http://casbon.me/archives.html">Archives</a></li>
            </ul>
            <div class="header_box">
                <h1><a href="http://casbon.me">casbon.me</a></h1>
                <h2>James Casbon's Blog</h2>
            </div>
        </div>
        <a href="https://github.com/jamescasbon">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <div id="wrapper">
            <div id="content">
                <h4 class="date">Jun  3,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/connecting-to-githubs-oauth2-api-with-tornado" rel="bookmark" title="Permanent Link to &quot;Connecting to Github's OAuth2 API with Tornado&quot;">Connecting to Github's OAuth2 API with Tornado</a>
                    </h2>
                    
                    <p>Github has a nice OAuth2 API that we can use to manipulate git repos, gists,
etc.  I went through the process of implementing a Tornado based client for the
API.  This could allow a github backed application.  Note here, we are still
performing server side operations, so the client is relatively simple.  An
alternative approach is to do the github interaction in the browser.  If you are
interested in that, check this library.</p>
<p>Tornado takes a callback based approach, and we need to code the entire OAuth2
dance in this way.  There is an base class, tornado.auth.OAuth2Mixin, which can
perform a very small subset of the protocol.  The steps we need to log in a
user:</p>
<ol>
<li>
<p>Get an authorization code using authorize_redirect method from the base class.
This presents the user with a 'do you want to authorize this app dialog in
github'.  Github then posts back to our app with the code</p>
</li>
<li>
<p>Get a user access token by exchanging the code for an access token.  This is
done via a simple GET.  This means the user is now logged in.</p>
</li>
<li>
<p>Get the user details by asking the API for the user information</p>
</li>
<li>
<p>Parse the user information and store the relevant details in a session/whatever</p>
</li>
</ol>
<p>Here is a base class that takes care of many of these details.
get_authenticated_user needs an authorization code, which it uses to get an
access token.  If it succeeds, it calls _on_access_code, which makes an API
request to /user.  This is then returned to the callback set by the original
caller of get_authenticated_user.  It also provides github_request, which makes
an API call and hands the data to _parse_response which in turn hands it to the
callback specified by the caller.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.auth</span>
<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.httputil</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="k">class</span> <span class="nc">GithubMixin</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">OAuth2Mixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Github OAuth Mixin, based on FacebookGraphMixin</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_OAUTH_AUTHORIZE_URL</span> <span class="o">=</span> <span class="s">&#39;https://github.com/login/oauth/authorize&#39;</span>
    <span class="n">_OAUTH_ACCESS_TOKEN_URL</span> <span class="o">=</span> <span class="s">&#39;https://github.com/login/oauth/access_token&#39;</span>
    <span class="n">_API_URL</span> <span class="o">=</span> <span class="s">&#39;https://api.github.com&#39;</span>

    <span class="k">def</span> <span class="nf">get_authenticated_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span>
                            <span class="n">code</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">extra_fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handles the login for Github, queries /user and returns a user object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;gau &#39;</span> <span class="o">+</span> <span class="n">redirect_uri</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
        <span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="s">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">client_secret</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_token_url</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_access_token</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span>
                                <span class="n">client_secret</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">fields</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span>
                        <span class="n">callback</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; callback for authentication url, if successful get the user details &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Github auth error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">parse_qs_bytes</span><span class="p">(</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;oauth error &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">github_request</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s">&quot;/user&quot;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_get_user_info</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">session</span><span class="p">),</span>
            <span class="n">access_token</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_get_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; callback for github request /user to create a user &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;user data from github &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">callback</span><span class="p">({</span>
            <span class="s">&quot;login&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;login&quot;</span><span class="p">],</span>
            <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">],</span>
            <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">],</span>
            <span class="s">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">],</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">github_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Makes a github API request, hands callback the parsed data &quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httputil</span><span class="o">.</span><span class="n">url_concat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_API_URL</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;request to &#39;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;body is&#39;</span> <span class="o">+</span>  <span class="n">body</span><span class="p">)</span>
        <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">,</span> <span class="n">callback</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse the JSON from the API &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;HTTP error from Github: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Invalid JSON from Github: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;error_code&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Facebook error: </span><span class="si">%d</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="p">[</span><span class="s">&quot;error_code&quot;</span><span class="p">],</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;error_msg&quot;</span><span class="p">))</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
</pre></div>


<p>We can use this, as below, to create handlers to login a user - and in this case
store the credentials in a secure cookie - or to make an API call for a logged
in user:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.options</span>
<span class="kn">import</span> <span class="nn">tornado.httputil</span>
<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">import</span> <span class="nn">pyjade.compiler</span>
<span class="kn">import</span> <span class="nn">coffeescript</span>
<span class="kn">import</span> <span class="nn">markdown</span>

<span class="kn">import</span> <span class="nn">github</span>


<span class="k">class</span> <span class="nc">GithubLoginHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="n">github</span><span class="o">.</span><span class="n">GithubMixin</span><span class="p">):</span>

    <span class="n">_OAUTH_REDIRECT_URL</span> <span class="o">=</span> <span class="s">&#39;http://localhost:8888/auth/github&#39;</span>

    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># we can append next to the redirect uri, so the user gets the</span>
        <span class="c"># correct URL on login</span>
        <span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httputil</span><span class="o">.</span><span class="n">url_concat</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_REDIRECT_URL</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;next&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;next&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)})</span>

        <span class="c"># if we have a code, we have been authorized so we can log in</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticated_user</span><span class="p">(</span>
                <span class="n">redirect_uri</span><span class="o">=</span><span class="n">redirect_uri</span><span class="p">,</span>
                <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;github_client_id&quot;</span><span class="p">],</span>
                <span class="n">client_secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;github_secret&quot;</span><span class="p">],</span>
                <span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">),</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_login</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># otherwise we need to request an authorization code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorize_redirect</span><span class="p">(</span>
                <span class="n">redirect_uri</span><span class="o">=</span><span class="n">redirect_uri</span><span class="p">,</span>
                <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;github_client_id&quot;</span><span class="p">],</span>
                <span class="n">extra_params</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;scope&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;github_scope&#39;</span><span class="p">],</span> <span class="s">&quot;foo&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_on_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This handles the user object from the login request &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;logged in user from github: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_secure_cookie</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">GistLister</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">,</span> <span class="n">github</span><span class="o">.</span><span class="n">GithubMixin</span><span class="p">):</span>

    <span class="nd">@tornado.web.authenticated</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">github_request</span><span class="p">(</span>
                <span class="s">&#39;/gists&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_get_gists</span><span class="p">,</span>
                <span class="n">access_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&#39;access_token&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_on_get_gists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gists</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;gists.jade&#39;</span><span class="p">,</span> <span class="n">gists</span><span class="o">=</span><span class="n">gists</span><span class="p">)</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/connecting-to-githubs-oauth2-api-with-tornado">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html">python</a>
                            <a href="http://casbon.me/tag/tornado.html">tornado</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>



                </div>

                <h4 class="date">Jan  9,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/html-templating-in-python-using-the-with-stat" rel="bookmark" title="Permanent Link to &quot;HTML Templating in Python using the with statement&quot;">HTML Templating in Python using the with statement</a>
                    </h2>
                    
                    <p>A few weeks back, I hacked up a simple templating language using
python's 'with' statement:</p>
<div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">Doc</span><span class="p">()</span>
<span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">:</span>

    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s">&#39;example page&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">link</span>  <span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/style.css&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">body</span> <span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="s">&#39;other stuff on another page&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/other.html&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">p</span> <span class="p">(</span><span class="s">&#39;stuff on this page&#39;</span><span class="p">)</span>
</pre></div>


<p>It was inspired by coffeekup and haml, since I find it much easier to
code html in those DSLs than with raw HTML (presumably, I need a
better editor to help match tags and indent).  HTML I write these days
tends to be as minimal as possible, and indent based languages help me
see the structure much better, which is a product of too long spent
with python.  See the gist below for the full description.</p>
<p>I posted this to <a href="https://news.ycombinator.com/item?id=3340369">Hacker
News</a> and it got into
the top ten briefly, with a few nice comments, a few why bothers and a
lot of prior art.  In particular, jperla's
<a href="http://www.jperla.com/blog/post/weby-templates-are-easier-faster-and-more-flexible">weby</a>
was very similar with a more involved syntax.  However, this getting
to the top ten shows how easy it is to have 15 seconds of fame these
days.  Next time, to number one.</p>
<p>Anyway, here is the gist:</p>
<div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A really stupid python template language inspired by coffeekup, markaby.</span>
<span class="sd">Do not use this code, it will ruin your day.  A byproduct of insomnia.</span>

<span class="sd">TL;DR</span>
<span class="sd">-----</span>

<span class="sd">This module defines a template language that allows us to do:</span>

<span class="sd">    d = Doc()</span>
<span class="sd">    with d.html:</span>

<span class="sd">        with d.head:</span>
<span class="sd">            d.title (&#39;example page&#39;)</span>
<span class="sd">            d.link  (rel=&#39;stylesheet&#39;, href=&#39;/style.css&#39;, type=&#39;text/css&#39;)</span>

<span class="sd">        with d.body (style=&#39;foo&#39;):</span>
<span class="sd">            d.a (&#39;other stuff on another page&#39;, href=&#39;/other.html&#39;)</span>
<span class="sd">            d.p (&#39;stuff on this page&#39;)</span>


<span class="sd">Motivation</span>
<span class="sd">----------</span>

<span class="sd">Python templating has always been a problem for me.  You normally have to</span>
<span class="sd">write in your target language (i.e. HTML) with some horrible syntax for</span>
<span class="sd">inlining python.  For example, this is a Cheetah [1] template:</span>

<span class="sd">    &lt;html&gt;</span>
<span class="sd">    &lt;head&gt;&lt;title&gt;$title&lt;/title&gt;&lt;/head&gt;</span>
<span class="sd">    &lt;body&gt;</span>
<span class="sd">        &lt;table&gt;</span>
<span class="sd">        #for $client in $clients</span>
<span class="sd">        &lt;tr&gt;</span>
<span class="sd">            &lt;td&gt;$client.surname, $client.firstname&lt;/td&gt;</span>
<span class="sd">            &lt;td&gt;&lt;a href=&quot;mailto:$client.email&quot;&gt;$client.email&lt;/a&gt;&lt;/td&gt;</span>
<span class="sd">        &lt;/tr&gt;</span>
<span class="sd">        #end for</span>
<span class="sd">        &lt;/table&gt;</span>
<span class="sd">    &lt;/body&gt;</span>
<span class="sd">    &lt;/html&gt;</span>

<span class="sd">We have &#39;$&#39; and &#39;#&#39; to inline python code and variables.  This to me is the</span>
<span class="sd">wrong way round.  I want to write python and not html.  I do not want to manage</span>
<span class="sd">html braces.  Tavis Rudd has pointed out that many of the arguments for</span>
<span class="sd">non python templates are unfounded [2] and I agree with him.  This has been</span>
<span class="sd">further enforced for me by using haml [3] and coffeekup [4], which leaves us in the</span>
<span class="sd">ridiculous position that the best indent based templating DSLs for html are in</span>
<span class="sd">non indent based languages (ruby, javascript).</span>

<span class="sd">This is why we can&#39;t have nice things</span>
<span class="sd">-------------------------------------</span>

<span class="sd">Coffescript and ruby have some advantage over python for a DSL including the</span>
<span class="sd">way anonymous blocks are defined and the ability to omit brackets and still get</span>
<span class="sd">function execution.  This means that the most direct python templates, such as</span>
<span class="sd">lxml builder[5] and breve [6] end up with a nested structure.  For example,</span>
<span class="sd">this is an lxml template:</span>

<span class="sd">    html = E.HTML(</span>
<span class="sd">        E.HEAD(</span>
<span class="sd">            E.LINK(rel=&quot;stylesheet&quot;, href=&quot;great.css&quot;, type=&quot;text/css&quot;),</span>
<span class="sd">            E.TITLE(&quot;Best Page Ever&quot;)</span>
<span class="sd">        ),</span>
<span class="sd">        E.BODY(</span>
<span class="sd">            E.H1(E.CLASS(&quot;heading&quot;), &quot;Top News&quot;),</span>
<span class="sd">            E.P(&quot;World News only on this page&quot;, style=&quot;font-size: 200%&quot;),</span>
<span class="sd">            &quot;Ah, and here&#39;s some more text, by the way.&quot;,</span>
<span class="sd">            lxml.html.fromstring(&quot;&lt;p&gt;    and this is a parsed fragment    &lt;/p&gt;&quot;)</span>
<span class="sd">        )</span>
<span class="sd">        )</span>

<span class="sd">Now, this code is python, but logic expressed this way still requires</span>
<span class="sd">management of parens and is not indent based - so is not really &#39;pythonic&#39;.</span>
<span class="sd">It also cannot really use conditionals and loops beyond ternarys and list comprehensions.</span>
<span class="sd">So I wondered if we could hook up a bit of magic using some other method.</span>
<span class="sd">So which way to go?  Function definitions would require too much magic, so it</span>
<span class="sd">seems that the best way is the _with_ statement.</span>

<span class="sd">The result is the style shown in the TL;DR above.  We can also</span>
<span class="sd">wrap this in a template method to use python conditional logic based</span>
<span class="sd">on supplied data:</span>

<span class="sd">    def example_template(items):</span>
<span class="sd">        d = Doc()</span>
<span class="sd">        with d.html:</span>

<span class="sd">            with d.head:</span>
<span class="sd">                d.title (&#39;other stuff on this page&#39;)</span>
<span class="sd">                d.link  (rel=&#39;stylesheet&#39;, href=&#39;/style.css&#39;, type=&#39;text/css&#39;)</span>

<span class="sd">            with d.body (style=&#39;foo&#39;):</span>
<span class="sd">                d.a (&#39;other stuff on another page&#39;, href=&#39;/other.html&#39;)</span>
<span class="sd">                d.p (&#39;stuff on this page&#39;)</span>
<span class="sd">                with d.ul:</span>
<span class="sd">                    for i in items:</span>
<span class="sd">                        with d.li:</span>
<span class="sd">                            d.a (str(i), href=str(i) + &#39;.html&#39;)</span>
<span class="sd">        return d.to_string()</span>

<span class="sd">The code below also shows template inheritance from python classes.</span>

<span class="sd">This is currently based on the lxml builder, and so it is slightly slower</span>
<span class="sd">than the elementree benchmarks [7] (which is pretty slow).  The lazy decorator</span>
<span class="sd">that allows us to miss out brackets on with statements is probably going</span>
<span class="sd">to make you cry.  Still this seems like a reasonable template language in</span>
<span class="sd">about 40 lines of code.</span>

<span class="sd">[1] http://www.cheetahtemplate.org/examples.html</span>
<span class="sd">[2] https://bitbucket.org/tavisrudd/throw-out-your-templates/src/98c5afba7f35/throw_out_your_templates.py</span>
<span class="sd">[3] http://haml-lang.com/</span>
<span class="sd">[4] http://coffeekup.org/</span>
<span class="sd">[5] http://lxml.de/dev/api/lxml.builder.ElementMaker-class.html</span>
<span class="sd">[6] http://breve.twisty-industries.com/</span>
<span class="sd">[7] http://spitfire.googlecode.com/svn/trunk/tests/perf/bigtable.py</span>

<span class="sd">Comments, abuse, etc to twitter @casualbon or casbon (at) gmail.com</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">lxml</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">lxml.html.builder</span>
<span class="kn">import</span> <span class="nn">lxml.etree</span>

<span class="k">class</span> <span class="nc">TagContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The context manager for an HTML tag &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;doc&#39;</span><span class="p">,</span> <span class="s">&#39;node&#39;</span><span class="p">,</span> <span class="s">&#39;tag&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create an html tag belonging to doc with given content and properties&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">c</span>

        <span class="n">text</span> <span class="o">+=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">builder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">())(</span><span class="o">**</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; entering the node appends it to the document stack &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; exiting the node pops it from the stack &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">each</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">():</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Lazydec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Horrible decorator to allow the with statement to omit</span>
<span class="sd">        brackets by tracking if context returned by doc has been entered</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;tagcallable&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">Doc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A document manages a stack, the head of which is the current context node &quot;&quot;&quot;</span>

    <span class="n">Context</span> <span class="o">=</span> <span class="n">TagContext</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># this node is set if text needs to be put in its tail</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Override getattr for quick tag access</span>

<span class="sd">            This means Doc.html returns a tag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; append raw text &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tail_node</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; append a html fragment (must be a single element) &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">fragment_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">ParserError</span><span class="p">:</span>
            <span class="n">els</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">fragments_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">els</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; convert this document to string &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pretty_print</span><span class="o">=</span><span class="n">pretty_print</span><span class="p">,</span>
                <span class="n">doctype</span><span class="o">=</span><span class="s">&#39;&lt;!DOCTYPE html&gt;&#39;</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">BootstrapContext</span><span class="p">(</span><span class="n">TagContext</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_add_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;class&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">+</span>  <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">cls</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>

        <span class="c"># support span and offset</span>
        <span class="k">for</span> <span class="n">gridcls</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;span&#39;</span><span class="p">,</span> <span class="s">&#39;offset&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">gridcls</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_class</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">gridcls</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="n">gridcls</span><span class="p">]))</span>
                <span class="n">props</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">gridcls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TagContext</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Bootstrap</span><span class="p">(</span><span class="n">Doc</span><span class="p">):</span>
    <span class="n">Context</span> <span class="o">=</span> <span class="n">BootstrapContext</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">example_template</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; template function example&quot;&quot;&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">Doc</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">p</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">():</span>
            <span class="n">d</span><span class="o">.</span><span class="n">fragment</span><span class="p">(</span><span class="s">&#39;&lt;h1&gt;no tail&lt;/h1&gt;&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s">&#39;other stuff on this page&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">link</span>  <span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/style.css&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">body</span> <span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">):</span>
                <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="s">&#39;other stuff on another page&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/other.html&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">p</span> <span class="p">(</span><span class="s">&#39;stuff on this page&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">ul</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">li</span><span class="p">():</span>

                            <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">href</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">)</span>

                <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;hi&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="s">&#39;.foo&#39;</span><span class="p">,</span> <span class="s">&#39;#bar&#39;</span><span class="p">,</span> <span class="s">&#39;inside el&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;bye&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>


    <span class="k">class</span> <span class="nc">BaseTemplate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; template inheritance example &quot;&quot;&quot;</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;base&#39;</span>

        <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">Doc</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">():</span>

                <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">():</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">link</span>  <span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s">&#39;/style.css&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">body</span> <span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">div</span> <span class="p">(</span><span class="s">&#39;#header&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">div</span> <span class="p">(</span><span class="s">&#39;#content&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">div</span> <span class="p">(</span><span class="s">&#39;#footer&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">footer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="s">&#39;Never read this content&#39;</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">ItemTemplate</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;item view&#39;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>

        <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s">&#39;view of </span><span class="si">%s</span><span class="s"> items&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">ul</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">li</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">li</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
                    <span class="n">li</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;the cake is a li&#39;</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">href</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bootstrap_example</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">html</span><span class="p">():</span>
            <span class="n">d</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="s">&#39;#main&#39;</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">example_template</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">print</span>
    <span class="k">print</span> <span class="n">ItemTemplate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">print</span>


    <span class="k">print</span> <span class="n">bootstrap_example</span><span class="p">()</span>
</pre></div>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/html-templating-in-python-using-the-with-stat">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html">python</a>
                            <a href="http://casbon.me/tag/templates.html">templates</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>



                </div>

                <h4 class="date">Jun  3,  2012</h4>
                <div class="post">
                    <h2 class="title">
                        <a href="http://casbon.me/pyvcf-06-release-cython-and-performance" rel="bookmark" title="Permanent Link to &quot;PyVCF 0.6 Release: Cython and Performance&quot;">PyVCF 0.6 Release: Cython and Performance</a>
                    </h2>
                    
                    <p>I just uploaded the <a href="https://crate.io/packages/PyVCF/">PyVCF 0.6 release</a> to pypi. &nbsp;This release concentrated on performance and will use a cythonized inner loop if you install it with cython. &nbsp;There is a small backwards incompatible change, which is that the call data (the cells in a VCF file) are now stored as a namedtuple.</p>

<p>A simple performance benchmark parsing a 1kg file:&nbsp;</p>

<ul>
<li>pyvcf: 1.8s / 100%</li>
<li>cyvcf: 2.3s / 127%</li>
<li>vcftools: 2.9s / 161%</li>
</ul>

                    <div class="clear"></div>
                    <div class="info">
                        <a href="http://casbon.me/pyvcf-06-release-cython-and-performance">posted at 10:20 am</a>&nbsp;&middot;&nbsp;<a href="http://casbon.me/category/python.html" rel="tag">Python</a>                        
                        <div class="tags">
                            <a href="http://casbon.me/tag/python.html">python</a>
                            <a href="http://casbon.me/tag/biology.html">biology</a>
                        </div>                        
                    </div>
                    <div class="clear"></div>



                </div>

                <div class="clear"></div>
                <div class="pages">                
                    <a href="http://casbon.me/author/james-casbon.html" class="prev_page">&larr;&nbsp;Previous</a>
                    <a href="http://casbon.me/author/james-casbon3.html" class="next_page">Next&nbsp;&rarr;</a>
                    <span>Page 2 of 3</span>
                </div>

                <div class="clear"></div>
                <div id="footer">
                    <p>
                    Mockingbird theme by <a href="http://nevanscott.com/">Nevan Scott</a>
                    &middot;
                    <a class="atom" href="http://casbon.me/feeds/all.atom.xml">Feed</a>
                </div>
            </div>
            <div class="clear"></div>
        </div>
            <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-27713114-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
        <script type="text/javascript">
    var disqus_shortname = 'casbonme';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    </body>
</html>